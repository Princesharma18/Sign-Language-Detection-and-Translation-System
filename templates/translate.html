{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Sign Language Translator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />

  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="75" cy="75" r="1" fill="rgba(255,255,255,0.05)"/><circle cx="50" cy="10" r="0.5" fill="rgba(255,255,255,0.08)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
      pointer-events: none;
      z-index: -1;
    }

    .main-container {
      padding: 30px 20px;
      position: relative;
      z-index: 1;
    }

    .card-panel {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      padding: 30px;
      height: 100%;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .card-panel:hover {
      transform: translateY(-5px);
      box-shadow: 0 25px 50px rgba(104, 89, 89, 0.15);
    }

    .form-section-title {
      font-weight: 700;
      margin-bottom: 24px;
      font-size: 1.4rem;
      color: #333;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .form-section-title i {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .media-preview {
      width: 100%;
      max-height: 350px;
      object-fit: contain;
      border-radius: 16px;
      border: 2px solid rgba(102, 126, 234, 0.2);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }

    .media-preview:hover {
      transform: scale(1.02);
      box-shadow: 0 12px 35px rgba(0, 0, 0, 0.15);
    }

    .btn-circle {
      border-radius: 50%;
      padding: 14px 16px;
      font-size: 1.2rem;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .btn-circle::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s ease;
    }

    .btn-circle:hover::before {
      left: 100%;
    }

    .btn-circle:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
    }

    .btn-secondary {
      background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
      border: none;
    }

    .btn-outline-primary {
      border: 2px solid #667eea;
      color: #667eea;
      background: rgba(102, 126, 234, 0.1);
      transition: all 0.3s ease;
    }

    .btn-outline-primary:hover,
    .btn-outline-primary:focus,
    .btn-outline-primary.active {
      background: linear-gradient(135deg, #667eea 0%, #b18bd8 100%);
      border-color: #667eea;
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }

    .btn-success {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      border: none;
    }

    .btn-success:hover {
      background: linear-gradient(135deg, #218838 0%, #1aa085 100%);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      border-radius: 12px;
      padding: 0.7rem 1.5rem;
      font-weight: 600;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .btn-primary::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s ease;
    }

    .btn-primary:hover::before {
      left: 100%;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(147, 162, 231, 0.4);
    }

    .btn-group .btn {
      border-radius: 12px;
      margin: 0 2px;
      border: 2px solid #667eea;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .btn-group .btn:first-child {
      border-radius: 12px 0 0 12px;
      margin-right: 0;
    }

    .btn-group .btn:last-child {
      border-radius: 0 12px 12px 0;
      margin-left: 0;
    }

    .btn-group .btn:not(:first-child):not(:last-child) {
      border-radius: 0;
      margin: 0;
    }

    .prediction-stats {
      background: rgba(248, 249, 250, 0.8);
      backdrop-filter: blur(5px);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .confidence-bar {
      height: 10px;
      background: rgba(233, 236, 239, 0.8);
      border-radius: 10px;
      overflow: hidden;
      position: relative;
    }

    .confidence-fill {
      height: 100%;
      background: linear-gradient(90deg, #dc3545 0%, #ffc107 50%, #28a745 100%);
      transition: width 0.8s ease;
      border-radius: 10px;
      position: relative;
    }

    .confidence-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .feedback-section {
      border-top: 2px solid rgba(102, 126, 234, 0.2);
      padding-top: 25px;
      margin-top: 25px;
      background: rgba(102, 126, 234, 0.05);
      border-radius: 16px;
      padding: 25px;
      margin-top: 25px;
    }

    .feedback-buttons {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
    }

    .btn-feedback {
      border-radius: 25px;
      padding: 10px 24px;
      font-size: 0.95rem;
      font-weight: 600;
      transition: all 0.3s ease;
      border: 2px solid;
      position: relative;
      overflow: hidden;
    }

    .btn-feedback::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s ease;
    }

    .btn-feedback:hover::before {
      left: 100%;
    }

    .btn-feedback.active {
      transform: scale(1.05);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
    }

    .btn-feedback:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .btn-outline-success {
      border-color: #28a745;
      color: #28a745;
    }

    .btn-outline-success:hover,
    .btn-outline-success.active {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      border-color: #28a745;
    }

    .btn-outline-danger {
      border-color: #dc3545;
      color: #dc3545;
    }

    .btn-outline-danger:hover,
    .btn-outline-danger.active {
      background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
      border-color: #dc3545;
    }

    .alert-custom {
      border-radius: 16px;
      border: none;
      padding: 1.2rem 1.8rem;
      margin-bottom: 20px;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }

    .alert-success {
      background: rgba(40, 167, 69, 0.1);
      color: #155724;
      border-left: 4px solid #28a745;
    }

    .alert-danger {
      background: rgba(220, 53, 69, 0.1);
      color: #721c24;
      border-left: 4px solid #dc3545;
    }

    .alert-warning {
      background: rgba(255, 193, 7, 0.1);
      color: #856404;
      border-left: 4px solid #ffc107;
    }

    .alert-info {
      background: rgba(23, 162, 184, 0.1);
      color: #0c5460;
      border-left: 4px solid #17a2b8;
    }

    .processing-indicator {
      display: none;
      text-align: center;
      padding: 25px;
      background: rgba(102, 126, 234, 0.1);
      border-radius: 16px;
      border: 2px dashed rgba(102, 126, 234, 0.3);
    }

    .required-feedback {
      border-left: 4px solid #dc3545;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.4); }
      70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
      100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
    }

    .confidence-fill {
      width: var(--confidence-width);
    }

    #emptyState {
      text-align: center;
      padding: 60px 20px;
      color: #6c757d;
    }

    #emptyState i {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 20px;
      animation: float 3s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }

    .modal-content {
      border-radius: 20px;
      border: none;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(10px);
    }

    .modal-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 20px 20px 0 0;
      padding: 1.5rem 2rem;
    }

    .modal-body {
      padding: 2rem;
    }

    .modal-footer {
      padding: 1.5rem 2rem;
      border-top: 1px solid rgba(0, 0, 0, 0.1);
    }

    #cameraModal video {
      width: 100%;
      border-radius: 16px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }

    .form-control {
      border: 2px solid #e9ecef;
      border-radius: 12px;
      padding: 0.8rem 1rem;
      font-size: 0.95rem;
      transition: all 0.3s ease;
    }

    .form-control:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }

    .form-label {
      font-weight: 600;
      color: #495057;
      margin-bottom: 0.8rem;
    }

    .text-primary {
      color: #667eea !important;
    }

    .bg-light {
      background: rgba(248, 249, 250, 0.8) !important;
      backdrop-filter: blur(5px);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .border {
      border: 2px solid rgba(102, 126, 234, 0.2) !important;
    }

    .rounded {
      border-radius: 12px !important;
    }

    /* Floating background elements */
    .floating-icon {
      position: fixed;
      color: rgba(255, 255, 255, 0.1);
      font-size: 2rem;
      animation: float 4s ease-in-out infinite;
      z-index: 0;
    }

    .floating-icon:nth-child(1) {
      top: 15%;
      left: 8%;
      animation-delay: 0s;
    }

    .floating-icon:nth-child(2) {
      top: 70%;
      right: 10%;
      animation-delay: 1.5s;
    }

    .floating-icon:nth-child(3) {
      bottom: 15%;
      left: 15%;
      animation-delay: 3s;
    }

    @media (max-width: 768px) {
      .main-container {
        padding: 20px 15px;
      }
      
      .card-panel {
        padding: 20px;
      }
      
      .form-section-title {
        font-size: 1.2rem;
      }
      
      .btn-group .btn {
        font-size: 0.9rem;
        padding: 0.6rem 1rem;
      }
      
      .feedback-buttons {
        flex-direction: column;
        gap: 10px;
      }
      
      .btn-feedback {
        width: 100%;
      }
    }

    .countdown-circle {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: 4px solid #007bff;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    .recording-pulse {
      animation: recordingPulse 1s infinite;
    }

    @keyframes recordingPulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
  </style>
  
</head>

<body>
  {% include 'navigation.html' %}

  <!-- Camera Modal -->
  <div class="modal fade" id="cameraModal" tabindex="-1" aria-labelledby="cameraModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content bg-light p-3">
        <div class="modal-header border-0">
          <h5 class="modal-title" id="cameraModalTitle">Camera Capture</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <video id="cameraView" autoplay class="w-100 rounded" style="max-width: 640px; height: 480px; object-fit: cover;"></video>
          <div id="recordingIndicator" class="text-center mt-3" style="display: none;">
            <div class="spinner-border spinner-border-sm text-danger me-2" role="status"></div>
            <span class="text-danger fw-bold">Recording... <span id="recordingTimer">3</span>s</span>
          </div>
          <div id="countdownIndicator" class="text-center mt-3" style="display: none;">
            <div class="countdown-circle">
              <span id="countdownNumber" class="fs-1 fw-bold text-primary">3</span>
            </div>
            <p class="text-muted mt-2">Get ready...</p>
          </div>
          <input type="hidden" id="captured_image" name="captured_image" />
          <input type="hidden" id="captured_video" name="captured_video" />
          <input type="hidden" id="is_captured" name="is_captured" value="false" />
        </div>
        <div class="modal-footer border-0">
          <button class="btn btn-primary" id="captureBtn">
            <i class="bi bi-camera-fill me-2"></i>Capture
          </button>
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Feedback Modal -->
  <div class="modal fade" id="feedbackModal" tabindex="-1" aria-labelledby="feedbackModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="feedbackModalLabel">Prediction Feedback</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <!-- Django Form -->
        <form method="POST" action="{% url 'feedback' %}" id="feedbackForm">
          {% csrf_token %}
          <div class="modal-body">
            <p>Please provide feedback on this prediction to help us improve:</p>

            <!-- Hidden field for prediction ID -->
            <input type="hidden" name="prediction_id" id="predictionId" value="">

            <!-- Feedback Type Selection -->
            <div class="feedback-buttons mb-3">
              <button type="button" class="btn btn-outline-success btn-feedback" data-feedback="like">
                <i class="bi bi-hand-thumbs-up me-2"></i>Good
              </button>
              <button type="button" class="btn btn-outline-danger btn-feedback" data-feedback="dislike">
                <i class="bi bi-hand-thumbs-down me-2"></i>Bad
              </button>
            </div>

            <!-- Hidden field for feedback type -->
            <input type="hidden" name="feedback_type" id="feedbackType" value="">

            <!-- Comment Field -->
            <div class="mb-3">
              <label for="feedbackComment" class="form-label">Additional Comments (Optional):</label>
              <textarea class="form-control" name="comment" id="feedbackComment" rows="3"
                placeholder="Tell us what went wrong or how we can improve..."></textarea>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Skip</button>
            <button type="submit" class="btn btn-primary" id="submitFeedback" disabled>Submit Feedback</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="container-fluid main-container">
    <!-- Display Messages -->
    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-custom alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}

    <div class="row g-4">
      <!-- Left Panel -->
      <div class="col-lg-5 col-md-6">
        <div class="card-panel h-100">
          <div class="form-section-title">
            <i class="bi bi-upload me-2"></i>Upload Input
          </div>
          <form method="post" enctype="multipart/form-data" id="uploadForm">
            {% csrf_token %}

            <div class="mb-4">
              <label class="form-label">Select Category:</label>
              <div class="btn-group w-100">
                <input type="radio" class="btn-check" name="category" id="alphabetBtn" value="alphabet"
                  autocomplete="off" {% if category == 'alphabet' %}checked{% endif %}>
                <label class="btn btn-outline-primary w-100" for="alphabetBtn">
                  <i class="bi bi-alphabet me-2"></i>Alphabet
                </label>

                <input type="radio" class="btn-check" name="category" id="digitBtn" value="digit" autocomplete="off"
                  {% if category == 'digit' %}checked{% endif %}>
                <label class="btn btn-outline-primary w-100" for="digitBtn">
                  <i class="bi bi-123 me-2"></i>Digit
                </label>

                <input type="radio" class="btn-check" name="category" id="videoBtn" value="video" autocomplete="off"
                  {% if category == 'video' %}checked{% endif %}>
                <label class="btn btn-outline-primary w-100" for="videoBtn">
                  <i class="bi bi-camera-video me-2"></i>Video
                </label>
              </div>
            </div>

            <input type="hidden" id="input_type" name="input_type" value="{{ input_type|default:'image' }}" />
            <input type="hidden" id="captured_image_form" name="captured_image" />
            <input type="hidden" id="captured_video_form" name="captured_video" />
            <input type="hidden" id="is_captured_form" name="is_captured" value="false" />

            <div class="d-flex gap-3 align-items-center mb-4">
              <button type="button" class="btn btn-secondary btn-circle" id="attachBtn" title="Attach File">
                <i class="bi bi-paperclip"></i>
              </button>
              <button type="button" class="btn btn-outline-primary btn-circle" id="openCameraBtn" title="Open Camera">
                <i class="bi bi-camera-fill"></i>
              </button>
              <input type="file" id="mediaInput" name="media" accept="image/*" class="d-none" />
              <button type="submit" class="btn btn-success btn-circle" id="submitBtn" title="Send">
                <i class="bi bi-send-fill"></i>
              </button>
            </div>

            <div class="processing-indicator" id="processingIndicator">
              <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
              <span>Processing your request...</span>
            </div>
          </form>
        </div>
      </div>

      <!-- Right Panel -->
      <div class="col-lg-7 col-md-6">
        <div class="card-panel h-100">
          <div class="form-section-title">
            <i class="bi bi-robot me-2"></i>Prediction Output
          </div>

          <div id="resultContainer" class="{% if media_url %}d-block{% else %}d-none{% endif %}">
            <!-- Media Preview -->
            <div id="mediaPreviewArea" class="mb-3">
              {% if media_url %}
                {% if input_type == 'video' %}
                  <video controls class="media-preview" style="width: 640px; height: 480px; object-fit: cover;">
                    <source src="{{ media_url }}" type="video/mp4" />
                    Your browser does not support the video tag.
                  </video>
                {% else %}
                  <img src="{{ media_url }}" class="media-preview" style="width: 640px; height: 480px; object-fit: cover;" alt="Input Image" />
                {% endif %}
              {% endif %}
            </div>

            <!-- Prediction Result -->
            <div class="mb-3">
              <h6 class="text-muted mb-2">
                <i class="bi bi-brain me-2"></i>Prediction Result:
              </h6>
              <div class="p-3 border rounded bg-light">
                <p id="predictionText" class="fs-5 fw-semibold text-primary mb-0">
                  {% if prediction %}
                    {{ prediction }}
                  {% else %}
                    Ready to process...
                  {% endif %}
                </p>
              </div>
            </div>

            <!-- Prediction Statistics -->
            {% if confidence or processing_time %}
              <div class="prediction-stats">
                <div class="row g-3">
                  {% if confidence %}
                    <div class="col-md-6">
                      <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-muted">Confidence:</span>
                        <span class="fw-bold" id="confidenceValue">{{ confidence|floatformat:1 }}%</span>
                      </div>
                      <div class="confidence-bar">
                        <div class="confidence-fill" style="--confidence-width: {{ confidence }}%;"></div>
                      </div>
                    </div>
                  {% endif %}
                  {% if processing_time %}
                    <div class="col-md-6">
                      <div class="d-flex justify-content-between align-items-center">
                        <span class="text-muted">Processing Time:</span>
                        <span class="fw-bold">{{ processing_time|floatformat:2 }}s</span>
                      </div>
                    </div>
                  {% endif %}
                </div>
              </div>
            {% endif %}

            <!-- Feedback Section -->
            {% if prediction_id and feedback_required %}
              <div class="feedback-section {% if feedback_required %}required-feedback{% endif %}">
                <h6 class="text-muted mb-3">
                  <i class="bi bi-chat-heart me-2"></i>Feedback Required
                  {% if feedback_required %}
                    <span class="text-danger">*</span>
                  {% endif %}
                </h6>
                <div class="feedback-buttons">
                  <button type="button" class="btn btn-outline-success btn-feedback" data-feedback="like"
                    data-prediction-id="{{ prediction_id }}">
                    <i class="bi bi-hand-thumbs-up me-2"></i>Good Prediction
                  </button>
                  <button type="button" class="btn btn-outline-danger btn-feedback" data-feedback="dislike"
                    data-prediction-id="{{ prediction_id }}">
                    <i class="bi bi-hand-thumbs-down me-2"></i>Poor Prediction
                  </button>
                </div>
                <div class="mb-3" id="feedbackCommentSection" style="display: none;">
                  <label for="feedbackComment" class="form-label">Tell us what went wrong:</label>
                  <textarea class="form-control" id="feedbackComment" rows="3"
                    placeholder="Your feedback helps us improve..."></textarea>
                </div>
                <button type="button" class="btn btn-primary btn-sm" id="submitFeedbackBtn" style="display: none;">
                  Submit Feedback
                </button>
              </div>
            {% endif %}
          </div>

          <!-- Empty State -->
          <div id="emptyState" class="{% if media_url %}d-none{% else %}d-block{% endif %} text-center py-5">
            <i class="bi bi-cloud-upload text-muted" style="font-size: 4rem;"></i>
            <h5 class="text-muted mt-3">No media uploaded yet</h5>
            <p class="text-muted">Choose a category and upload an image or video to get started</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // DOM Elements
    const mediaInput = document.getElementById('mediaInput');
    const inputTypeField = document.getElementById('input_type');
    const preview = document.getElementById('mediaPreviewArea');
    const container = document.getElementById('resultContainer');
    const emptyState = document.getElementById('emptyState');
    const predictionText = document.getElementById('predictionText');
    const openCameraBtn = document.getElementById('openCameraBtn');
    const cameraModal = new bootstrap.Modal(document.getElementById('cameraModal'));
    const feedbackModal = new bootstrap.Modal(document.getElementById('feedbackModal'));
    const cameraView = document.getElementById('cameraView');
    const captureBtn = document.getElementById('captureBtn');
    const submitBtn = document.getElementById('submitBtn');
    const processingIndicator = document.getElementById('processingIndicator');
    const uploadForm = document.getElementById('uploadForm');
    const cameraModalTitle = document.getElementById('cameraModalTitle');
    const recordingIndicator = document.getElementById('recordingIndicator');
    const countdownIndicator = document.getElementById('countdownIndicator');
    const recordingTimer = document.getElementById('recordingTimer');
    const countdownNumber = document.getElementById('countdownNumber');

    // Standard dimensions for consistency with OpenCV
    const CAPTURE_WIDTH = 640;
    const CAPTURE_HEIGHT = 480;

    let stream;
    let mediaRecorder;
    let recordedChunks = [];
    let selectedFeedback = null;
    let currentPredictionId = null;
    let isRecording = false;
    let recordingTimeout;
    let countdownInterval;

    // Category change handler
    document.querySelectorAll('input[name="category"]').forEach(btn => {
      btn.addEventListener('change', () => {
        const type = btn.value;
        inputTypeField.value = type === 'video' ? 'video' : 'image';
        mediaInput.accept = type === 'video' ? 'video/*' : 'image/*';
        
        // Update camera button text and modal title
        if (type === 'video') {
          openCameraBtn.innerHTML = '<i class="bi bi-camera-video-fill"></i>';
          openCameraBtn.title = 'Record Video';
        } else {
          openCameraBtn.innerHTML = '<i class="bi bi-camera-fill"></i>';
          openCameraBtn.title = 'Take Photo';
        }

        // Clear previous media
        clearMedia();
      });
    });

    // File attachment
    document.getElementById('attachBtn').addEventListener('click', () => mediaInput.click());

    // File input change
    mediaInput.addEventListener('change', () => {
      const file = mediaInput.files[0];
      if (!file) return;

      const url = URL.createObjectURL(file);
      showMedia(url, file.type);
      predictionText.textContent = 'File attached. Click Send to process.';

      // Set input type based on file
      if (file.type.startsWith('video/')) {
        inputTypeField.value = 'video';
        // Update category selection
        document.getElementById('videoBtn').checked = true;
      } else {
        inputTypeField.value = 'image';
      }
    });

    // Camera functionality
    openCameraBtn.addEventListener('click', async () => {
      const category = document.querySelector('input[name="category"]:checked').value;
      
      // Update modal title based on category
      cameraModalTitle.textContent = category === 'video' ? 'Video Recording' : 'Photo Capture';
      
      // Update capture button text
      captureBtn.innerHTML = category === 'video' 
        ? '<i class="bi bi-record-circle me-2"></i>Record Video'
        : '<i class="bi bi-camera-fill me-2"></i>Take Photo';

      try {
        const constraints = {
          video: {
            width: { ideal: CAPTURE_WIDTH },
            height: { ideal: CAPTURE_HEIGHT },
            facingMode: 'user'
          }
        };

        if (category === 'video') {
          constraints.audio = true;
        }

        stream = await navigator.mediaDevices.getUserMedia(constraints);
        cameraView.srcObject = stream;
        cameraModal.show();
      } catch (e) {
        console.error('Camera error:', e);
        alert('Camera access denied or not available.');
      }
    });

    // Capture functionality
    captureBtn.addEventListener('click', () => {
      const category = document.querySelector('input[name="category"]:checked').value;
      
      if (category === 'video') {
        if (!isRecording) {
          startVideoRecording();
        } else {
          stopVideoRecording();
        }
      } else {
        captureImage();
      }
    });

    // Start video recording with countdown
    function startVideoRecording() {
      if (isRecording) return;

      // Show countdown
      countdownIndicator.style.display = 'block';
      captureBtn.disabled = true;
      
      let countdown = 2;
      countdownNumber.textContent = countdown;
      
      countdownInterval = setInterval(() => {
        countdown--;
        if (countdown > 0) {
          countdownNumber.textContent = countdown;
        } else {
          clearInterval(countdownInterval);
          countdownIndicator.style.display = 'none';
          startActualRecording();
        }
      }, 1000);
    }

    function startActualRecording() {
      recordedChunks = [];
      
      try {
        mediaRecorder = new MediaRecorder(stream, {
          mimeType: 'video/webm;codecs=vp8,opus'
        });

        mediaRecorder.ondataavailable = (event) => {
          if (event.data.size > 0) {
            recordedChunks.push(event.data);
          }
        };

        mediaRecorder.onstop = () => {
          const blob = new Blob(recordedChunks, { type: 'video/webm' });
          const reader = new FileReader();
          reader.onloadend = () => {
            const base64data = reader.result;
            document.getElementById('captured_video_form').value = base64data;
            document.getElementById('is_captured_form').value = 'true';
            
            const url = URL.createObjectURL(blob);
            showMedia(url, 'video/webm');
            predictionText.textContent = 'Video recorded successfully! Click Send to process.';
            
            // Stop camera stream
            if (stream) {
              stream.getTracks().forEach(track => track.stop());
            }
            cameraModal.hide();
          };
          reader.readAsDataURL(blob);
        };

        mediaRecorder.start();
        isRecording = true;
        
        // Update UI for recording
        captureBtn.innerHTML = '<i class="bi bi-stop-circle me-2"></i>Stop Recording';
        captureBtn.disabled = false;
        captureBtn.classList.add('btn-danger');
        captureBtn.classList.remove('btn-primary');
        cameraView.classList.add('recording-pulse');
        
        // Show recording indicator
        recordingIndicator.style.display = 'block';
        
        // Start countdown timer
        let timeLeft = 3;
        recordingTimer.textContent = timeLeft;
        
        const timerInterval = setInterval(() => {
          timeLeft--;
          recordingTimer.textContent = timeLeft;
          
          if (timeLeft <= 0) {
            clearInterval(timerInterval);
            if (isRecording) {
              stopVideoRecording();
            }
          }
        }, 1000);
        
        // Auto-stop after 3 seconds
        recordingTimeout = setTimeout(() => {
          if (isRecording) {
            stopVideoRecording();
          }
        }, 3000);

      } catch (error) {
        console.error('Recording error:', error);
        alert('Failed to start recording. Please try again.');
        resetRecordingUI();
      }
    }

    function stopVideoRecording() {
      if (!isRecording) return;
      
      isRecording = false;
      
      if (recordingTimeout) {
        clearTimeout(recordingTimeout);
      }
      
      if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
      }
      
      resetRecordingUI();
    }

    function resetRecordingUI() {
      captureBtn.innerHTML = '<i class="bi bi-record-circle me-2"></i>Record Video';
      captureBtn.classList.remove('btn-danger', 'recording-pulse');
      captureBtn.classList.add('btn-primary');
      captureBtn.disabled = false;
      cameraView.classList.remove('recording-pulse');
      recordingIndicator.style.display = 'none';
      countdownIndicator.style.display = 'none';
      
      if (countdownInterval) {
        clearInterval(countdownInterval);
      }
    }

    // Capture image with consistent dimensions
    function captureImage() {
      const canvas = document.createElement('canvas');
      canvas.width = CAPTURE_WIDTH;
      canvas.height = CAPTURE_HEIGHT;
      const context = canvas.getContext('2d');
      
      // Draw video frame to canvas with proper scaling
      context.drawImage(cameraView, 0, 0, CAPTURE_WIDTH, CAPTURE_HEIGHT);

      const dataURL = canvas.toDataURL('image/jpeg', 0.9);
      document.getElementById('captured_image_form').value = dataURL;
      document.getElementById('is_captured_form').value = 'true';

      showMedia(dataURL, 'image/jpeg');
      predictionText.textContent = 'Image captured successfully! Click Send to process.';

      // Stop camera stream
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }
      cameraModal.hide();
    }

    // Form submission
    uploadForm.addEventListener('submit', (e) => {
      e.preventDefault();

      // Show processing indicator
      processingIndicator.style.display = 'block';
      submitBtn.disabled = true;

      // Submit form
      uploadForm.submit();
    });

    // Feedback handling
    document.querySelectorAll('.btn-feedback').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const feedbackType = e.currentTarget.dataset.feedback;
        const predictionId = e.currentTarget.dataset.predictionId;
        if (!predictionId) return;

        selectedFeedback = feedbackType;
        currentPredictionId = predictionId;

        // Update button states
        document.querySelectorAll('.btn-feedback').forEach(b => b.classList.remove('active'));
        e.currentTarget.classList.add('active');

        // Show comment section for negative feedback
        const commentSection = document.getElementById('feedbackCommentSection');
        const submitBtn = document.getElementById('submitFeedbackBtn');

        if (feedbackType === 'dislike') {
          commentSection.style.display = 'block';
          submitBtn.style.display = 'inline-block';
        } else {
          commentSection.style.display = 'none';
          submitBtn.style.display = 'inline-block';
        }

        submitBtn.disabled = false;
      });
    });

    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.startsWith(name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    // Submit feedback
    document.getElementById('submitFeedbackBtn').addEventListener('click', () => {
      if (!selectedFeedback || !currentPredictionId) return;

      const comment = document.getElementById('feedbackComment').value;
      const submitBtn = document.getElementById('submitFeedbackBtn');
      
      // Show loading state
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Submitting...';

      const formData = new FormData();
      formData.append('prediction_id', currentPredictionId);
      formData.append('feedback_type', selectedFeedback);
      formData.append('comment', comment);
      formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));

      fetch('{% url "feedback" %}', {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
        }
      })
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          if (data.success) {
            document.querySelector('.feedback-section').innerHTML = `
              <div class="alert alert-success">
                <i class="bi bi-check-circle me-2"></i>
                Thank you for your feedback!
              </div>
            `;
          } else {
            throw new Error(data.message || 'Failed to submit feedback');
          }
        })
        .catch(error => {
          console.error('Feedback error:', error);
          alert('Failed to submit feedback: ' + error.message);
          
          // Reset button state
          submitBtn.disabled = false;
          submitBtn.innerHTML = 'Submit Feedback';
        });
    });

    // Modal cleanup
    document.getElementById('cameraModal').addEventListener('hidden.bs.modal', () => {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }
      if (isRecording) {
        stopVideoRecording();
      }
      resetRecordingUI();
    });

    // Helper functions
    function showMedia(url, type) {
      container.classList.remove('d-none');
      emptyState.classList.add('d-none');

      const mediaStyle = `style="width: ${CAPTURE_WIDTH}px; height: ${CAPTURE_HEIGHT}px; object-fit: cover;"`;
      
      if (type.startsWith('video/')) {
        preview.innerHTML = `<video controls class="media-preview" ${mediaStyle} src="${url}"></video>`;
      } else {
        preview.innerHTML = `<img src="${url}" class="media-preview" ${mediaStyle} alt="Preview Image" />`;
      }
    }

    function clearMedia() {
      container.classList.add('d-none');
      emptyState.classList.remove('d-none');
      preview.innerHTML = '';
      predictionText.textContent = '';
      mediaInput.value = '';
      document.getElementById('captured_image_form').value = '';
      document.getElementById('captured_video_form').value = '';
      document.getElementById('is_captured_form').value = 'false';
    }

    // Initialize
    window.addEventListener('DOMContentLoaded', () => {
      const currentCategory = document.querySelector('input[name="category"]:checked')?.value || 'alphabet';
      
      // Update camera button based on initial category
      if (currentCategory === 'video') {
        openCameraBtn.innerHTML = '<i class="bi bi-camera-video-fill"></i>';
        openCameraBtn.title = 'Record Video';
      } else {
        openCameraBtn.innerHTML = '<i class="bi bi-camera-fill"></i>';
        openCameraBtn.title = 'Take Photo';
      }
    });

    // Handle page reload after form submission
    window.addEventListener('DOMContentLoaded', () => {
      const hasMedia = '{{ media_url|yesno:"true,false" }}' === 'true';
      if (hasMedia) {
        processingIndicator.style.display = 'none';
        submitBtn.disabled = false;
      }
    });
  </script>
</body>

</html>